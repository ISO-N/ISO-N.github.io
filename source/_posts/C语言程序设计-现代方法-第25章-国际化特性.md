---
title: 第25章 国际化特性
date: 2026-02-17 02:20:34
categories:
- [编程技术, C]
tags:
- C语言程序设计-现代方法
---
## 25.1 `<locale.h>`：本地化

- **locale（区域设置）** 是一组影响程序行为的区域性规则，包括字符集、日期/时间格式、数值格式、货币格式等
- C 语言通过 `<locale.h>` 头提供对区域设置的支持

### 类别

区域设置被分为若干 **类别（category）**，每个类别控制一方面的本地化行为：

| 宏 | 影响范围 |
| --- | --- |
| `LC_COLLATE` | `strcoll` 和 `strxfrm` 的字符串比较行为 |
| `LC_CTYPE` | `<ctype.h>` 中字符处理函数的行为 |
| `LC_MONETARY` | `localeconv` 返回的货币格式信息 |
| `LC_NUMERIC` | 小数点字符的格式、`localeconv` 返回的非货币格式信息 |
| `LC_TIME` | `strftime` 的日期/时间格式行为 |
| `LC_ALL` | 以上所有类别 |

### `setlocale` 函数

```c
char *setlocale(int category, const char *locale);
```

- **作用**：设置或查询当前的区域设置
- `category`：要设置的类别（如 `LC_ALL`、`LC_NUMERIC` 等）
- `locale`：
    - `"C"` — 默认的最小区域环境（程序启动时的默认设置）
    - `""` — 使用本地环境（由操作系统决定）
    - `NULL` — 查询当前区域设置，不修改
    - 其他实现定义的字符串
- **返回值**：指向描述新区域设置的字符串的指针；若设置失败返回 `NULL`

```c
// 典型用法
setlocale(LC_ALL, "");    // 启用本地区域
setlocale(LC_ALL, "C");   // 恢复默认
char *cur = setlocale(LC_ALL, NULL);  // 查询当前区域
```

### `localeconv` 函数

```c
struct lconv *localeconv(void);
```

- **作用**：返回一个指向 `struct lconv` 的指针，其中包含当前区域的数值和货币格式信息
- 返回的结构体不应被程序修改

### `struct lconv` 的主要成员

- 非货币格式化成员
    - `char *decimal_point` — 小数点字符（默认 `"."`）
    - `char *thousands_sep` — 千位分隔符
    - `char *grouping` — 数字分组方式（从右到左的每组位数）
- 货币格式化成员
    - `char *currency_symbol` — 本地货币符号（如 `"￥"`）
    - `char *int_curr_symbol` — 国际货币符号（如 `"CNY "`）
    - `char *mon_decimal_point` — 货币小数点
    - `char *mon_thousands_sep` — 货币千位分隔符
    - `char *mon_grouping` — 货币数字分组
    - `char *positive_sign` / `char *negative_sign` — 正/负值符号
    - `char frac_digits` — 本地货币小数位数
    - `char int_frac_digits` — 国际货币小数位数
    - `char p_cs_precedes` / `char n_cs_precedes` — 货币符号是否在正/负值之前
    - `char p_sep_by_space` / `char n_sep_by_space` — 货币符号与正/负值之间是否有空格
    - `char p_sign_posn` / `char n_sign_posn` — 正/负号的位置

---

## 25.2 多字节字符与宽字符

### 概念区分

- **多字节字符（multibyte character）**：使用 1 个或多个字节表示一个字符，字节数可变
    - 例如：UTF-8 中，ASCII 用 1 字节，中文用 3 字节
    - 适合外部存储和传输
- **宽字符（wide character）**：使用固定大小（通常 2 或 4 字节）的 `wchar_t` 类型表示一个字符
    - 适合程序内部处理，便于随机访问和操作

### 多字节字符与宽字符的转换

```c
// 多字节字符 → wchar_t
int mbtowc(wchar_t *pwc, const char *s, size_t n);

// wchar_t → 多字节字符
int wctomb(char *s, wchar_t wc);

// 多字节字符串 → 宽字符串
size_t mbstowcs(wchar_t *pwcs, const char *s, size_t n);

// 宽字符串 → 多字节字符串
size_t wcstombs(char *s, const wchar_t *pwcs, size_t n);
```

- `mbtowc` 返回消耗的字节数；若 `s` 为 `NULL`，返回编码是否是状态相关的
- `wctomb` 返回写入的字节数
- `mbstowcs` / `wcstombs` 返回转换的字符数（不含终止符）；出错返回 `(size_t)-1`

### `mblen` 函数

```c
int mblen(const char *s, size_t n);
```

- 返回多字节字符的字节数
- 若 `s` 为 `NULL`，返回编码是否与状态相关

---

## 25.3 三字符序列与双字符序列

### 三字符序列（Trigraph）

某些老式键盘可能缺少 C 语言所需的部分字符，三字符序列提供替代写法：

| 三字符序列 | 替换为 |
| --- | --- |
| `??=` | `#` |
| `??(` | `[` |
| `??/` | `\` |
| `??)` | `]` |
| `??'` | `^` |
| `??<` | `{` |
| `??!` | `\ |
| `??>` | `}` |
| `??-` | `~` |
- 三字符序列在编译的最早阶段被替换，甚至在字符串字面量和字符常量中也会替换
- 实际开发中极少使用，主要了解即可

### 双字符序列（Digraph）（C99）

C99 引入了更可读的替代写法：

| 双字符 | 替换为 |
| --- | --- |
| `<:` | `[` |
| `:>` | `]` |
| `<%` | `{` |
| `%>` | `}` |
| `%:` | `#` |
| `%:%:` | `##` |
- 与三字符序列不同，双字符**不会**在字符串字面量和字符常量中被替换

### `<iso646.h>`（C95）

提供一组宏作为逻辑和位运算符的替代拼写：

| 宏 | 等价于 |
| --- | --- |
| `and` | `&&` |
| `and_eq` | `&=` |
| `bitand` | `&` |
| `bitor` | `\ |
| `compl` | `~` |
| `not` | `!` |
| `not_eq` | `!=` |
| `or` | `\ |
| `or_eq` | `\ |
| `xor` | `^` |
| `xor_eq` | `^=` |

---

## 25.4 通用字符名（C99）

- C99 允许在标识符、字符常量和字符串字面量中使用 **通用字符名（Universal Character Name）**
- 语法：
    - `\uXXXX` — 4 位十六进制，表示 U+0000 到 U+FFFF
    - `\UXXXXXXXX` — 8 位十六进制，表示完整的 Unicode 码点

```c
// 示例
char *greeting = "\u4f60\u597d";  // "你好"
```

---

## 25.5 `<wchar.h>`：宽字符扩展支持（C95/C99）

`<wchar.h>` 提供了一整套宽字符版本的函数，对应标准库中 `char` 版本的函数。

### 宽字符 I/O 函数

| 宽字符版本 | 对应的 `char` 版本 | 说明 |
| --- | --- | --- |
| `fwprintf` | `fprintf` | 宽字符格式化输出 |
| `fwscanf` | `fscanf` | 宽字符格式化输入 |
| `wprintf` | `printf` | 宽字符标准输出 |
| `wscanf` | `scanf` | 宽字符标准输入 |
| `fgetwc` | `fgetc` | 读取宽字符 |
| `fgetws` | `fgets` | 读取宽字符串 |
| `fputwc` | `fputc` | 写入宽字符 |
| `fputws` | `fputs` | 写入宽字符串 |
| `getwchar` | `getchar` | 从 stdin 读取宽字符 |
| `putwchar` | `putchar` | 向 stdout 写入宽字符 |
| `ungetwc` | `ungetc` | 退回宽字符 |

### 宽字符串操作函数

| 宽字符版本 | 对应的 `char` 版本 |
| --- | --- |
| `wcscpy` / `wcsncpy` | `strcpy` / `strncpy` |
| `wcscat` / `wcsncat` | `strcat` / `strncat` |
| `wcscmp` / `wcsncmp` | `strcmp` / `strncmp` |
| `wcschr` / `wcsrchr` | `strchr` / `strrchr` |
| `wcsstr` | `strstr` |
| `wcslen` | `strlen` |
| `wcstok` | `strtok` |
| `wcscoll` | `strcoll` |
| `wcsxfrm` | `strxfrm` |
| `wmemcpy` / `wmemmove` | `memcpy` / `memmove` |
| `wmemcmp` | `memcmp` |
| `wmemset` | `memset` |
| `wmemchr` | `memchr` |

### 宽字符串与数值转换

| 函数 | 对应 `char` 版本 |
| --- | --- |
| `wcstod` / `wcstof` / `wcstold` | `strtod` / `strtof` / `strtold` |
| `wcstol` / `wcstoul` | `strtol` / `strtoul` |
| `wcstoll` / `wcstoull` | `strtoll` / `strtoull` |

### 宽字符时间函数

```c
size_t wcsftime(wchar_t *s, size_t maxsize, const wchar_t *format, const struct tm *timeptr);
```

- 对应 `strftime`，输出宽字符格式的日期/时间字符串

### `mbstate_t` 与可重入转换函数

- `mbstate_t` 类型用于记录多字节字符的转换状态
- 可重入（restartable）版本的转换函数：

| 函数 | 说明 |
| --- | --- |
| `mbrtowc` | 可重入的 `mbtowc` |
| `wcrtomb` | 可重入的 `wctomb` |
| `mbsrtowcs` | 可重入的 `mbstowcs` |
| `wcsrtombs` | 可重入的 `wcstombs` |
| `mbrlen` | 可重入的 `mblen` |
- `btowc` / `wctob`：单字节与宽字符的快速转换

---

## 25.6 `<wctype.h>`：宽字符分类与转换（C95）

`<wctype.h>` 提供宽字符版本的字符分类和转换函数，对应 `<ctype.h>`。

### 分类函数

| 宽字符版本 | 对应 `<ctype.h>` | 说明 |
| --- | --- | --- |
| `iswalpha` | `isalpha` | 字母 |
| `iswdigit` | `isdigit` | 数字 |
| `iswalnum` | `isalnum` | 字母或数字 |
| `iswspace` | `isspace` | 空白字符 |
| `iswupper` | `isupper` | 大写字母 |
| `iswlower` | `islower` | 小写字母 |
| `iswpunct` | `ispunct` | 标点符号 |
| `iswprint` | `isprint` | 可打印字符 |
| `iswgraph` | `isgraph` | 可打印非空白字符 |
| `iswcntrl` | `iscntrl` | 控制字符 |
| `iswxdigit` | `isxdigit` | 十六进制数字 |
| `iswblank` | `isblank` | 空格或制表符（C99） |

### 可扩展分类

```c
wctype_t wctype(const char *property);
int iswctype(wint_t wc, wctype_t desc);
```

- `wctype("alpha")` 等价于获取 `iswalpha` 的分类描述符
- 允许区域设置定义额外的自定义字符分类

### 转换函数

| 宽字符版本 | 对应 `<ctype.h>` |
| --- | --- |
| `towupper` | `toupper` |
| `towlower` | `tolower` |

### 可扩展转换

```c
wctrans_t wctrans(const char *property);
wint_t towctrans(wint_t wc, wctrans_t desc);
```

- `wctrans("toupper")` 等价于获取 `towupper` 的转换描述符
- 允许区域设置定义额外的自定义字符转换