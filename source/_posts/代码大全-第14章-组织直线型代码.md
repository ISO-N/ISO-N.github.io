---
title: 第14章 组织直线型代码
date: 2026-02-17 15:25:03
categories:
- [软件工程, 理论]
tags:
- 代码大全
---
本章讨论如何组织不含循环或条件分支的**顺序执行**的代码，使其更易读、易维护、减少出错。

---

## 必须有明确顺序的语句

当语句之间存在**数据依赖**或**逻辑依赖**时，执行顺序不能随意调整。

### 组织原则

- **让依赖关系变得明显**：使前一条语句的结果自然地成为下一条语句的输入
- **用函数参数使依赖关系明确**：将上一步的返回值作为下一步的参数传入，而非依赖隐式的共享变量
- **用注释说明不明显的依赖**：如果依赖关系无法通过代码结构本身体现，应加注释说明
- **用断言或错误处理检查依赖**：对关键的顺序依赖使用断言（assertion），确保前置条件已满足

### 示例

```
// 不好的做法：依赖关系不明显
computeMarketingExpense();
computeSalesExpense();
computeTravelExpense();
computePersonnelExpense();
displayExpenseSummary();

// 好的做法：通过参数传递使依赖关系显式化
marketingExpense = computeMarketingExpense();
salesExpense = computeSalesExpense(marketingExpense);
travelExpense = computeTravelExpense();
personnelExpense = computePersonnelExpense(travelExpense);
displayExpenseSummary(marketingExpense, salesExpense, travelExpense, personnelExpense);
```

---

## 顺序无关的语句

当语句之间**没有依赖**关系时，执行顺序在逻辑上无关紧要，但合理的排列仍然能大幅提升可读性。

### 组织原则

- **就近原则（Proximity）**：把相关的操作放在一起，减少读者在代码中上下跳转的需要
- **让代码自上而下阅读**：读者应能从上往下顺畅阅读，不需要反复回头查看
- **把相关语句分组**：用空行将逻辑上相关的语句分为一组，每组形成一个"段落"

### 衡量"相关性"的方法

可以从以下维度判断语句之间的相关性：

| **维度** | **说明** |
| --- | --- |
| 操作同一数据 | 对同一变量的初始化、赋值、使用应放在一起 |
| 执行相似任务 | 功能类似的操作应归为一组 |
| 执行顺序依赖 | 有先后关系的语句必须按顺序排列 |

---

## 减少变量"存活"时间

<aside>
💡

**存活时间（Live Time）** = 变量最后一次被引用的位置 − 变量第一次被引用的位置之间的语句数。

</aside>

### 为什么要缩短存活时间？

- **减少注意力窗口**：存活时间短意味着读者只需关注一小段代码就能理解变量的用途
- **降低出错风险**：变量在更短的范围内被使用，不容易被意外修改
- **便于重构**：相关代码集中在一起，更容易提取成独立函数

### 做法

1. **在首次使用变量的位置附近声明和初始化它**
2. **集中使用变量**：把对同一变量的所有引用尽量放在一起
3. **避免过早声明变量**：不要在函数开头一次性声明所有变量

```
// 不好的做法：变量声明远离使用位置，存活时间长
int a = 0;
int b = 0;
int c = 0;
// ...很多无关代码...
a = getInput();
// ...很多无关代码...
b = calculate(a);
// ...很多无关代码...
c = output(b);

// 好的做法：声明靠近首次使用，存活时间短
int a = getInput();
int b = calculate(a);
int c = output(b);
```

---

## 跨度（Span）

<aside>
💡

**跨度** = 同一变量两次相邻引用之间的语句数。目标是让跨度尽可能**小**。

</aside>

- 跨度与存活时间配合来衡量变量的集中程度
- 短跨度意味着变量的使用更加集中，代码更易读

---

## 核心要点总结

<aside>
⭐

- 组织直线型代码的**首要原则**是让依赖关系清晰可见
- 对于顺序无关的代码，使用**就近原则**和**分组**提升可读性
- 尽量缩短变量的**存活时间**和**跨度**，让相关代码靠在一起
- 善用**函数参数、命名、注释和断言**来表达语句之间的依赖关系
- 如果一段直线型代码变得过长，考虑将逻辑上独立的部分**提取为子程序**
</aside>